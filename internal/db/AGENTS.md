# Database Layer

## Overview

PostgreSQL CRUD via pgx v5 connection pool. Hand-written SQL, no ORM. All data access flows through the `db.Store` interface.

## Files

| File | Purpose |
|------|---------|
| `store.go` | `Store` interface (95 methods) — central abstraction for all DB consumers |
| `models.go` | 9 model structs + enum constants (TaskStatus, MCPServerStatus, Roles) |
| `db.go` | `DB` struct, `New()`, `Close()`, `RunMigrations()`, utility functions |
| `dbmock/store.go` | In-memory `Store` implementation for unit testing (exported fields for state injection) |
| `ssh_key.go` | SSHKey CRUD |
| `project.go` | Project CRUD |
| `provider_config.go` | ProviderConfig CRUD + GetByPath + ListAll |
| `trigger_keyword.go` | TriggerKeyword Set (transactional) / Get |
| `task.go` | Task Create / UpdateStatus / List (paginated) / Get / Count |
| `webhook.go` | WebhookDelivery IsProcessed / Record (ON CONFLICT DO NOTHING) |
| `setting.go` | Setting Get / GetBool / GetString / GetInt / GetDuration / Set (UPSERT) / List / Delete |
| `mcp_server.go` | MCPServer CRUD + UpdateStatus / ListEnabled |
| `user.go` | User CRUD + GetByUsername / UpdatePassword / Count |

## Store Interface Pattern

```
db.Store interface (95 methods)
    ├── *db.DB          — production PostgreSQL (pgx v5 pool)
    └── *dbmock.Store   — in-memory mock (exported fields, ErrDefault for error injection)
```

All consuming packages (auth, api, analyzer, provider, mcp, mcpmgr, server) depend on `db.Store`, never `*db.DB`.

## Connection Pool

```go
MaxConns: 20, MinConns: 2, MaxConnLifetime: 30 min
```

## Entity Mapping

| Struct | Table | Operations |
|--------|-------|------------|
| `SSHKey` | `ssh_keys` | Create/List/Get/Delete |
| `Project` | `projects` | CRUD |
| `ProviderConfig` | `provider_configs` | Create/List/Get/GetByPath/ListAll/Delete |
| `TriggerKeyword` | `trigger_keywords` | Set (transactional: delete old → insert new) / Get |
| `Task` | `tasks` | Create/UpdateStatus/List (paginated)/Get/Count |
| `WebhookDelivery` | `webhook_deliveries` | IsProcessed/Record (ON CONFLICT DO NOTHING) |
| `Setting` | `settings` | Get/GetBool/GetString/GetInt/GetDuration/Set (UPSERT)/List/Delete |
| `MCPServer` | `mcp_servers` | CRUD + UpdateStatus/ListEnabled |
| `User` | `users` | CRUD + GetByUsername/UpdatePassword/Count |

## Conventions

- All IDs are UUIDs generated by PostgreSQL `gen_random_uuid()`
- Return types use pointer slices `[]*Model`
- `QueryRow` + `Scan` for single-row reads
- `Query` + `rows.Next()` + `Scan` for multi-row reads
- Errors returned unwrapped (callers handle)
- `ListSSHKeys` omits `private_key` column (security)
- `User.PasswordHash` tagged `json:"-"` (never serialized)

## Adding a New Entity

1. Add struct to `models.go`
2. Add methods to `store.go` interface
3. Create `{entity}.go` with SQL implementations on `*DB`
4. Add corresponding methods to `dbmock/store.go`
5. Add migration SQL to `migrations/`

## Notes

- No transaction wrapper utility — use `Pool.Begin()` directly when needed
- `ListTasks` supports pagination (LIMIT/OFFSET); other List methods do not
- `Setting.Value` is `json.RawMessage` — stores arbitrary JSON
